<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Micha Hanselmann"><meta name="description" content="I write audio apps and blog about it."><meta name="keywords" content="deermichel,coding,sound,music,audio,dsp,programming,midi,daw,effect,plugin,realtime,blog,rust,cpp"><title>AUv3 &amp; SwiftUI: Embed Audio Unit Extensions in a Multiplatform App - soaky audio</title><style>:root{--font-family:system-ui,-apple-system,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Noto Sans",sans-serif;--font-family-monospace:ui-monospace,"Menlo","Consolas","Roboto Mono","Oxygen Mono","Ubuntu Monospace","Noto Mono",monospace;--font-size:18px;--font-size-small:14px;--content-width:768px;--logo-size:42px;--nav-height:48px;--nav-width:1024px;--gap:22px;--accent-color:#0b72c1;--background-color:#fcfcfc;--border-color:rgba(34, 34, 34, 0.2);--text-color:#222;--text-color-secondary:rgba(34, 34, 34, 0.7)}@media (prefers-color-scheme:dark){:root{--accent-color:#57a9e8;--background-color:#222;--border-color:rgba(225, 225, 225, 0.2);--text-color:#eee;--text-color-secondary:rgba(225, 225, 225, 0.7)}}body,html{background-color:var(--background-color);color:var(--text-color);font-family:var(--font-family);font-size:var(--font-size);line-height:1.2;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}*{box-sizing:border-box;margin:0;padding:0}:focus{outline:0}a{color:inherit;font-weight:700;text-decoration-color:var(--accent-color);transition:.1s ease-out}a:focus,a:hover{color:var(--accent-color)}h1{font-size:2.5rem;margin-bottom:var(--gap)}h2{font-size:1.6rem;padding-top:var(--gap)}h3{font-size:1.2rem;padding-top:var(--gap)}img{display:block;margin:0 auto;max-width:100%}ol,ul{padding-left:1.5em}ol,p,ul{line-height:1.8;margin:var(--gap) 0}code,pre{font-family:var(--font-family-monospace)}blockquote{border-left:.25em solid var(--border-color);color:var(--text-color-secondary);padding-left:var(--gap)}.header-nav{display:flex;flex-wrap:wrap;justify-content:space-between;margin:0 auto;max-width:var(--nav-width);padding-bottom:var(--gap);padding-left:var(--gap)}.header-nav a{align-items:center;display:flex;margin-right:var(--gap);margin-top:var(--gap);text-decoration:none}.header-logo{height:var(--logo-size);margin-right:var(--gap);width:var(--logo-size)}.header-menu{display:flex}.header-menu a:focus,.header-menu a:hover{text-decoration:underline}.footer{color:var(--text-color-secondary);line-height:1.8;margin:var(--gap) 0}.footer-row{font-size:var(--font-size-small);text-align:center}.footer-row a{text-decoration:none}.footer-row a:focus,.footer-row a:hover{text-decoration:underline}.content{margin:0 auto;max-width:var(--content-width);padding:var(--gap)}img+em{color:var(--text-color-secondary);display:block;margin-top:calc(var(--font-size)/ 4);text-align:center}.anchor-link{color:transparent;text-decoration:none}.anchor-link:focus,.anchor-link:hover{color:var(--accent-color)}.tagline{color:var(--text-color-secondary);text-align:center}.posts-list time{color:var(--text-color-secondary);font-size:var(--font-size-small)}.post time{color:var(--text-color-secondary);font-size:var(--font-size-small)}.post-content{padding-top:var(--gap)}.post-title{margin-bottom:0}code[class*=language-],pre[class*=language-]{background:#272b33;color:#aab1bf;text-shadow:0 1px rgba(0,0,0,.3);direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#3e4450;color:inherit;text-shadow:none}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#3e4450;color:inherit;text-shadow:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-]{padding:.2em .3em;border-radius:.3em;white-space:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}.token.cdata,.token.comment,.token.prolog{color:#5b6270}.token.doctype,.token.entity,.token.punctuation{color:#aab1bf}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#d19965}.token.keyword{color:#c578dd}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#df6b75}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#97c279}.token.function,.token.operator,.token.variable{color:#61afef}.token.url{color:#56b5c2}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#aab1bf}.language-css .token.selector{color:#df6b75}.language-css .token.property{color:#aab1bf}.language-css .token.function,.language-css .token.url>.token.function{color:#56b5c2}.language-css .token.url>.token.string.url{color:#97c279}.language-css .token.atrule .token.rule,.language-css .token.important{color:#c578dd}.language-javascript .token.operator{color:#c578dd}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#be5046}.language-json .token.operator{color:#aab1bf}.language-json .token.null.keyword{color:#d19965}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#aab1bf}.language-markdown .token.url>.token.content{color:#61afef}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#56b5c2}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#5b6270;font-style:italic}.language-markdown .token.code-snippet{color:#97c279}.language-markdown .token.bold .token.content{color:#d19965}.language-markdown .token.italic .token.content{color:#c578dd}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#df6b75}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:hsla(220,14%,71%,.15);text-shadow:none}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#393f4a;color:#818896;padding:.1em .4em;border-radius:.3em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#3e4450;color:#aab1bf}.line-highlight.line-highlight{background:hsla(220,100%,80%,.04)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#393f4a;color:#aab1bf;padding:.1em .6em;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2)}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:hsla(220,100%,80%,.04)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:hsla(220,14%,71%,.15)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#626d82}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#df6b75}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#97c279}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#61afef}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#c578dd}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:hsla(353,100%,66%,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:hsla(353,95%,66%,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:hsla(353,95%,66%,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:hsla(137,100%,55%,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:hsla(135,73%,55%,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:hsla(135,73%,55%,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:#252830}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:#252830}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:#252830}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#30353f}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:hsl(220,14%,71%);stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:hsl(220,14%,71%)}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}</style><link rel="icon" type="image/svg+xml" href="/img/logo.svg?v=1"></head><body><header><nav class="header-nav"><a href="/"><img class="header-logo" src="/img/logo.svg" alt="soakyaudio logo"> <b>soaky audio</b></a><div class="header-menu"><a href="/">blog</a> <a href="/designer">designer</a></div></nav></header><main class="content"><article class="post"><h1 class="post-title">AUv3 &amp; SwiftUI: Embed Audio Unit Extensions in a Multiplatform App</h1><time datetime="2023-01-03">January 3, 2023</time><div class="post-content"><p>SwiftUI makes it easy to build multiplatform apps using a single codebase. However, the current Xcode templates for application extensions only support one target platform, meaning that you have to create separate extensions for each platform when developing a multiplatform app. This can result in unnecessary duplication of code, especially when bundling <a href="https://developer.apple.com/documentation/avfaudio/audio_engine/audio_units/creating_an_audio_unit_extension">audio unit extensions</a>, since AUv3 supports both macOS and iOS.</p><p>Let us start by creating a new multiplatform project in Xcode:</p><p><img src="/img/2023-01-03-multiplatform-audiounit/00-create-project.png" alt="Create multiplatform app project in Xcode"> <em>Create a new Xcode project, then select <strong>Multiplatform</strong>, <strong>App</strong> and click <strong>Next</strong>.</em></p><p><img src="/img/2023-01-03-multiplatform-audiounit/01-create-project.png" alt="Set project metadata"> <em>Fill the metadata, click <strong>Next</strong>, then select a path and hit <strong>Create</strong>.</em></p><p>Try to run your newly created project on macOS and iOS to verify your build is working. Then proceed with adding an app extension by selecting the root project and pressing the small <strong>+</strong> icon at the bottom of the left <strong>Targets</strong> sidebar:</p><p><img src="/img/2023-01-03-multiplatform-audiounit/02-add-extension.png" alt="Select root project and press plus icon in targets sidebar"> <em>Select root project and press <strong>+</strong> icon in the <strong>Targets</strong> sidebar.</em></p><p><img src="/img/2023-01-03-multiplatform-audiounit/03-add-extension.png" alt="Choose macOS audio unit extension template"> <em>Choose <strong>macOS</strong>, <strong>Audio Unit Extension</strong> and press <strong>Next</strong>.</em></p><blockquote><p>While it is also possible to start from an iOS extension template, it takes slightly more effort to fix up the UI part on macOS targets (aka copying the missing files from the macOS template). That obviously only matters if your audio unit comes with its own user interface.</p></blockquote><p>In the next dialog, you will need to set the metadata for the audio unit. Xcode will generate a different template based on the audio unit type and whether a UI should be included. It is best to examine the <a href="https://developer.apple.com/documentation/avfaudio/audio_engine/audio_units/creating_an_audio_unit_extension">various options</a> and select the most suitable one, as adjusting the templates later and understanding the internals of AUv3 can be quite time-consuming.</p><p><img src="/img/2023-01-03-multiplatform-audiounit/04-add-extension.png" alt="Set audio unit metadata"> <em>Fill the metadata, in particular <strong>Audio Unit Type</strong> and <strong>User Interface</strong>, then click <strong>Finish</strong>.</em></p><p>After Xcode generated the template code, let us see the macOS audio unit in action. Activate the scheme of the extension (<strong>FancyInstrument</strong>), set the target platform (<strong>My Mac</strong>) and click <strong>Run</strong>. You will be asked for a host app to run the audio unit - any app that supports AUv3 plugins will do, e.g. Logic Pro X, GarageBand or AU Lab (bundled with <a href="https://developer.apple.com/download/all/?q=Additional%20Tools%20for%20Xcode">Additional Tools for Xcode</a>).</p><p><img src="/img/2023-01-03-multiplatform-audiounit/05-run-macos.png" alt="Select app to run the macOS audio unit"> <em>Select the extension scheme, the target platform and click <strong>Run</strong>. Then choose an app to run the unit and confirm with <strong>Run</strong>.</em></p><p>You should be able to use your audio unit like any other plugin. While the host application is running, you can also validate the unit via the <code>auval</code> tool.</p><p><img src="/img/2023-01-03-multiplatform-audiounit/06-run-macos.png" alt="Opened audio unit in Logic Pro X"> <em>Logic Pro X lists instrument audio units (remember the Audio Unit Type) under <strong>AU Instruments</strong>, whereas effects are found in <strong>Audio FX</strong> -&gt; <strong>Audio Units</strong>.</em></p><p><img src="/img/2023-01-03-multiplatform-audiounit/07-run-macos.png" alt="Use auval to validate the audio unit"> <em>Use <code>auval</code> to validate the audio unit.</em></p><p>Close the host application and head back to Xcode. If you try to run the same scheme on an iOS target, you will be greeted by a <em>&quot;run destination not valid&quot;</em> error message. Let us fix that in the build settings:</p><p><img src="/img/2023-01-03-multiplatform-audiounit/08-build-settings.png" alt="Navigate to the audio unit build settings"> <em>Select root project and extension target, then <strong>Build Settings</strong> and verify <strong>All</strong> is selected.</em></p><p><img src="/img/2023-01-03-multiplatform-audiounit/09-build-settings.png" alt="Add iOS to supported platforms"> <em>Under <strong>Architectures</strong> -&gt; <strong>Supported Platforms</strong>, choose <strong>Other...</strong> and add the <strong>iphonesimulator</strong> and <strong>iphoneos</strong> platform strings.</em></p><p><img src="/img/2023-01-03-multiplatform-audiounit/10-build-settings.png" alt="Set base SDK to automatic"> <em>Under <strong>Architectures</strong> -&gt; <strong>Base SDK</strong>, choose <strong>Other...</strong> and enter <strong>auto</strong>.</em></p><p>Since the macOS view controller <code>xib</code> file does not support iOS targets, you have to exclude it from the <strong>Copy Bundle Resources</strong> build step:</p><p><img src="/img/2023-01-03-multiplatform-audiounit/11-build-settings.png" alt="Exclude xib file from copy bundle resources build step"> <em>Under <strong>Build Phases</strong> -&gt; <strong>Copy Bundle Resources</strong>, locate the view controller <code>xib</code> file, select <strong>Filters</strong> and activate <strong>macOS</strong> only.</em></p><blockquote><p>Side note: If you examined the audio unit extension template for iOS, you would see that it includes a storyboard in place of the <code>xib</code> file. In my testing, the storyboard was not necessary to get the UI working on iOS - in fact, no matter what I changed, the changes were not reflected in the final audio unit. I might get something wrong here, so please do not hesitate to <a href="mailto:hello@soakyaudio.com">reach out</a> if you have better insight into this.</p></blockquote><p>Completing these steps lets you build the extension for iOS, but the install step fails due to a provisioning profile error. This is caused by sandbox settings that are necessary on macOS but do not apply to iOS. Luckily, Xcode allows conditional settings based on the SDK which can reconcile both worlds:</p><p><img src="/img/2023-01-03-multiplatform-audiounit/12-build-settings.png" alt="Conditional sandbox settings for macOS and iOS"> <em>Back under <strong>Build Settings</strong>, search for the <strong>Signing</strong> section. Add conditional settings by pressing the small <strong>+</strong> icon.</em></p><p>The <strong>Enable App Sandbox</strong> setting should be <strong>No</strong> by default and <strong>Yes</strong> for <strong>Any macOS SDK</strong>. The <strong>Enable User Selected Files</strong> setting should be <strong>None</strong> by default and <strong>Read-Only</strong> for <strong>Any macOS SDK</strong>. Getting these settings wrong will cause your audio unit not showing up on macOS.</p><p>Try to run the extension scheme on an iOS target now. To use AUv3 plugins on your iOS device, you will need a compatible host application, such as GarageBand:</p><p><img src="/img/2023-01-03-multiplatform-audiounit/13-run-ios.png" alt="Select app to run the iOS audio unit"> <em>Select the extension scheme, an iOS target and click <strong>Run</strong>. Then choose an app to run the unit and confirm with <strong>Run</strong>.</em></p><p><img src="/img/2023-01-03-multiplatform-audiounit/14-run-ios.png" alt="Create external audio unit extension track in GarageBand"> <em>In GarageBand, add a new external track, selecting <strong>Audio Unit Extensions</strong>.</em></p><blockquote><p>If you cannot see the audio unit in the host app, try running the app scheme (<strong>FancyAudioApp</strong>) first to install the main app. Then switch back to the extension scheme, run it and proceed from there.</p></blockquote><p><img src="/img/2023-01-03-multiplatform-audiounit/15-run-ios.png" alt="Audio unit user interface in GarageBand"> <em>To open the user interface, tap the controls button on the top.</em></p><p>If everything works up to this point, do a sanity check on macOS by switching back to a macOS target platform and rerunning the extension scheme. Your audio unit should still show up in the host app and the user interface should be working too.</p><p>That is it, you have successfully created a multiplatform app with an audio unit extension, all using a single codebase. I uploaded the final project to <a href="https://github.com/soakyaudio/multiplatform-audiounit">GitHub</a> as a reference.</p><p>If you have any additional questions or would like to provide feedback, please contact me via <a href="mailto:hello@soakyaudio.com">email</a>. You can also find discussion about this post on the relevant <a href="https://news.ycombinator.com/item?id=34266028">Hacker News thread</a>. If you enjoy my content and would like to support me, feel free to purchase one of <a href="https://apps.apple.com/developer/micha-hanselmann/id1544237803">my apps</a>.</p></div></article></main><footer class="footer"><div class="footer-row">&#169; 2023 soaky audio</div><div class="footer-row"><a href="https://deermichel.me">About</a> &bull; <a href="https://github.com/soakyaudio">GitHub</a> &bull; <a href="/feed.xml">RSS</a></div></footer></body></html>